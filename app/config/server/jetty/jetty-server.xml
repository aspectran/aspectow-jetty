<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE aspectran PUBLIC "-//ASPECTRAN//DTD Aspectran 9.0//EN"
        "https://aspectran.com/dtd/aspectran-9.dtd">
<aspectran>

    <description>
        Aspectran configuration for setting up a Jetty server.
    </description>

    <environment>
        <property name="jetty.server.port" value="8081" valueType="int"/>
        <property name="jetty.server.minThreads" value="3" valueType="int"/>
        <property name="jetty.server.maxThreads" value="10" valueType="int"/>
        <property name="jetty.server.maxConnections" value="9999" valueType="int"/>
        <property name="jetty.server.gzip.minGzipSize" value="32" valueType="int"/>
    </environment>

    <bean id="jetty.server" class="com.aspectran.jetty.server.JettyServer">
        <argument>
            <bean class="org.eclipse.jetty.util.thread.QueuedThreadPool">
                <property name="minThreads">%{jetty.server.minThreads}</property>
                <property name="maxThreads">%{jetty.server.maxThreads}</property>
            </bean>
        </argument>
        <property name="maxConnections">%{jetty.server.maxConnections}</property>
        <property name="connectors" type="array">
            <value>#{jetty.server.serverConnector}</value>
        </property>
        <property name="handler">
            <value>#{jetty.server.mainHandler}</value>
        </property>
        <property name="requestLog">
            <value>#{jetty.server.requestLog}</value>
        </property>
    </bean>

    <bean id="jetty.server.serverConnector"
          class="org.eclipse.jetty.server.ServerConnector"
          scope="prototype">
        <argument>#{jetty.server}</argument>
        <argument type="array">
            <bean class="org.eclipse.jetty.server.HttpConnectionFactory">
                <argument>
                    <bean class="org.eclipse.jetty.server.HttpConfiguration">
                        <property name="customizers" type="list">
                            <bean class="org.eclipse.jetty.server.ForwardedRequestCustomizer"/>
                        </property>
                    </bean>
                </argument>
            </bean>
        </argument>
        <property name="port">%{jetty.server.port}</property>
    </bean>

    <bean id="jetty.server.mainHandler"
          class="org.eclipse.jetty.server.handler.StatisticsHandler"
          scope="prototype">
        <argument>
            <bean class="org.eclipse.jetty.server.handler.gzip.GzipHandler">
                <argument>#{jetty.server.handler.loggingGroupHandlerHandler}</argument>
                <property name="minGzipSize" valueType="int">%{jetty.server.gzip.minGzipSize}</property>
            </bean>
        </argument>
    </bean>

    <bean id="jetty.server.handler.loggingGroupHandlerHandler"
          class="com.aspectran.jetty.server.handler.PathBasedLoggingGroupHandler"
          scope="prototype">
        <argument>
            <bean class="org.eclipse.jetty.server.handler.ContextHandlerCollection">
                <argument valueType="boolean">false</argument>
                <argument type="array">
                    <value>#{jetty.context.root.webAppContext}</value>
                    <value>#{jetty.context.appmon.webAppContext}</value>
                </argument>
            </bean>
        </argument>
        <property name="pathPatternsByGroupName" type="map">
            <entry name="appmon">
                +: /appmon/**
            </entry>
        </property>
    </bean>

    <bean id="jetty.server.requestLog"
          class="org.eclipse.jetty.server.CustomRequestLog"
          scope="prototype">
        <argument>
            <bean class="org.eclipse.jetty.server.Slf4jRequestLogWriter">
                <property name="loggerName">org.eclipse.jetty.server.RequestLog</property>
            </bean>
        </argument>
        <argument tokenize="false">%{yyyy-MM-dd HH:mm:ss.SSS ZZZ|GMT+9}t %{client}a %{X-Forwarded-For}i %{JSESSIONID}C "%r" %s %O "%{Referer}i" "%{User-Agent}i"</argument>
    </bean>

</aspectran>
